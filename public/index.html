<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>TTS API - Prueba</title>
  <style>
    body { font-family: system-ui, sans-serif; margin: 24px; max-width: 820px; }
    label { display:block; margin-top:12px; font-weight:600 }
    textarea { width:100%; height:140px; }
    select, input[type="text"] { width:100%; padding:8px; }
    button { margin-top:16px; padding:10px 14px; font-weight:600; }
    .row { display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
    .muted { color:#555; font-size:12px }
  </style>
</head>
<body>
  <h1>üéôÔ∏è TTS API</h1>

  <label for="voz">Voz</label>
  <select id="voz"></select>
  <div class="muted">Consejo: prob√° <b>dalia-mx</b>, <b>jorge-mx</b>, <b>elvira-es</b>, <b>alvaro-es</b>.</div>

  <div class="row">
    <div>
      <label for="velocidad">Velocidad (rate)</label>
      <input id="velocidad" type="text" value="+0%" />
    </div>
    <div>
      <label for="tono">Tono (pitch)</label>
      <input id="tono" type="text" value="+0Hz" />
    </div>
  </div>

  <label for="texto">Texto</label>
  <textarea id="texto" placeholder="Escrib√≠ el texto a convertir a voz..."></textarea>

  <button id="btn">Generar audio</button>

  <h2>Resultado</h2>
  <audio id="player" controls></audio>
  <div><a id="download" href="#" download>Descargar MP3</a></div>

  <script>
    const vozSel = document.getElementById('voz');
    const velocidad = document.getElementById('velocidad');
    const tono = document.getElementById('tono');
    const texto = document.getElementById('texto');
    const player = document.getElementById('player');
    const download = document.getElementById('download');
    const btn = document.getElementById('btn');

    async function cargarVoces() {
      const res = await fetch('/api/voces');
      const voces = await res.json();
      vozSel.innerHTML = '';
      for (const v of voces) {
        const opt = document.createElement('option');
        opt.value = v.id;
        opt.textContent = `${v.id} ‚Äî ${v.descripcion}`;
        vozSel.appendChild(opt);
      }
      vozSel.value = 'dalia-mx';
    }

    btn.addEventListener('click', async () => {
      btn.disabled = true; btn.textContent = 'Generando...';
      try {
        const res = await fetch('/api/tts', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            texto: texto.value,
            voz: vozSel.value,
            velocidad: velocidad.value,
            tono: tono.value
          })
        });
        if (!res.ok) {
          const err = await res.json().catch(()=>({error:'Error desconocido'}));
          alert('Error: ' + (err.detalle || err.error));
          return;
        }
        const blob = await res.blob();
        const url = URL.createObjectURL(blob);
        player.src = url;
        player.play();
        download.href = url;
        download.download = `tts_${Date.now()}.mp3`;
      } catch (e) {
        alert('Fallo de red: ' + e.message);
      } finally {
        btn.disabled = false; btn.textContent = 'Generar audio';
      }
    });

    cargarVoces();
  </script>
</body>
</html>
